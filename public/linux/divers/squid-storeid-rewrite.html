<!DOCTYPE html>
<html>
  <head>
    <title>
    Squid StoreId rewrite - wiki.ght1pc9kc.fr
</title>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="generator" content="Hugo 0.40.2" />
<title>Squid StoreId rewrite :: wiki.ght1pc9kc.fr</title>
<link rel="shortcut icon" href="/images/logo.png" type="image/x-icon" />
<link href="/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/nucleus.css" rel="stylesheet">
<link href="/css/style.css" rel="stylesheet">
<link rel="stylesheet" href="/css/bootstrap.min.css">
<script src="/js/jquery-2.x.min.js"></script>
<script type="text/javascript">
      var baseurl = "";
</script>
  </head>
  <body data-url="/linux/divers/squid-storeid-rewrite.html">

    <header>
  
  <div class="logo">
	<a class="baselink" href="">
	    <img src="/images/logo.png" alt="wiki.ght1pc9kc.fr"/> wiki.ght1pc9kc.fr
	</a>
</div>
<span class="spacer">&nbsp;</span>
<div class="navbar-right">
    <form class="navbar-form navbar-left" action="/search.html" method="get">
       <input id="search-box" name="query" placeholder="Search..." autocomplete="off" spellcheck="false" dir="auto" type="text">
    </form>
</div>
</header>
<article>
  <aside class="menu">
    <div class="list-group">
        <a href="/cuisine.html" class="list-group-item list-group-item-action active">Cuisine</a>
    </div>
    <div class="list-group">
        <a href="/misc.html" class="list-group-item list-group-item-action active">Divers</a>
    </div>
    <div class="list-group">
        <a href="/development.html" class="list-group-item list-group-item-action active">Développement</a>
        <a href="/development/dotnet.html" class="list-group-item list-group-item-action ">.Net</a>
        <a href="/development/gwt.html" class="list-group-item list-group-item-action ">GWT</a>
        <a href="/development/java.html" class="list-group-item list-group-item-action ">Java</a>
        <a href="/development/javascript.html" class="list-group-item list-group-item-action ">Javascript</a>
        <a href="/development/spring.html" class="list-group-item list-group-item-action ">Spring</a>
    </div>
    <div class="list-group">
        <a href="/linux.html" class="list-group-item list-group-item-action active">Linux</a>
        <a href="/linux/administration.html" class="list-group-item list-group-item-action ">Administration</a>
        <a href="/linux/divers.html" class="list-group-item list-group-item-action ">Divers</a>
        <a href="/linux/gnomeshell.html" class="list-group-item list-group-item-action ">GnomeShell</a>
        <a href="/linux/network.html" class="list-group-item list-group-item-action ">Réseau</a>
        <a href="/linux/shell.html" class="list-group-item list-group-item-action ">Shell</a>
    </div>
    <div class="list-group">
        <a href="/outils.html" class="list-group-item list-group-item-action active">Outils</a>
        <a href="/outils/ansible.html" class="list-group-item list-group-item-action ">Ansible</a>
        <a href="/outils/docker.html" class="list-group-item list-group-item-action ">Docker</a>
        <a href="/outils/eclipse.html" class="list-group-item list-group-item-action ">Eclipse</a>
        <a href="/outils/git.html" class="list-group-item list-group-item-action ">Git</a>
        <a href="/outils/intellij.html" class="list-group-item list-group-item-action ">IntelliJ</a>
        <a href="/outils/latex.html" class="list-group-item list-group-item-action ">LaTeX</a>
        <a href="/outils/vmware.html" class="list-group-item list-group-item-action ">VMWare</a>
    </div>
    <div class="list-group">
        <a href="/serveurs.html" class="list-group-item list-group-item-action active">Serveur</a>
        <a href="/serveurs/http.html" class="list-group-item list-group-item-action ">HTTP</a>
        <a href="/serveurs/jboss.html" class="list-group-item list-group-item-action ">JBoss</a>
        <a href="/serveurs/mysql.html" class="list-group-item list-group-item-action ">MySQL</a>
        <a href="/serveurs/neo4j.html" class="list-group-item list-group-item-action ">Neo4J</a>
        <a href="/serveurs/oracle.html" class="list-group-item list-group-item-action ">Oracle</a>
        <a href="/serveurs/teradata.html" class="list-group-item list-group-item-action ">TeraData</a>
    </div>


  </aside>
  <section class="page">

    <h1>Squid StoreId rewrite</h1>
    
    

    <p>Un truc que j&rsquo;ai cherché à faire avec Squid est de mettre en cache les téléchargements que docker fait pour construire
ses images afin qu&rsquo;il ne re-télécharge pas systématiquement tout.</p>

<p>Pas compliqué, il suffit d&rsquo;augmenter la taille max des fichiers a cacher et du répertoire de cache :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-conf" data-lang="conf">cache_dir ufs /var/spool/squid3 5000 16 256
maximum_object_size 400 MB</code></pre></div>
<p>Mais j&rsquo;ai surtout eu un problème avec le téléchargement des JRE &amp; JDK Oracle. En effet, le lien demande une
authentification et redirige alors vers la même URL mais avec une query-string :</p>

<pre><code>http://download.oracle.com/otn-pub/java/jdk/7u75-b13/jre-7u75-linux-x64.tar.gz
</code></pre>

<p>devient</p>

<pre><code>http://download.oracle.com/otn-pub/java/jdk/7u75-b13/jre-7u75-linux-x64.tar.gz?AuthParam=jkhefuihzefglkjhazfligezkfg
</code></pre>

<p>Et biensur le <strong>AuthParam</strong> change à chaque fois. Du coup Squid considère le fichier comme un nouveau fichier et le
remet en cache a chaque fois. C&rsquo;est que qu&rsquo;on appelle la duplication. Pas gênant pour les petits fichiers, beaucoup plus
pour les gros.</p>

<p>Pour palier ce problème dans Squid 3.4 (pas avant) il est possible de re-écrire le
<a href="http://wiki.squid-cache.org/Features/StoreID">StoreId</a>. Pour cela, il faut commence par récupérer le programme perl <a href=".doc/store-id.pl">store-id.pl</a> que je rajoute ici au cas où :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl">{% include_relative <span style="color:#f92672">.</span>doc<span style="color:#f92672">/</span>store<span style="color:#f92672">-</span>id<span style="color:#f92672">.</span>pl %<span style="color:#960050;background-color:#1e0010">}</span></code></pre></div>
<p>Attention, ce fichier <strong>doit être exécutable</strong> !
Ensuite dans le fichier squid.conf on active la mise en cache des query-string en remplaçant :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language- conf" data-lang=" conf">refresh_pattern -i (/cgi-bin/|\?) 0       0%      0</code></pre></div>
<p>par</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-conf" data-lang="conf">refresh_pattern -i cgi-bin        0       0%      0</code></pre></div>
<p>Puis on ajoute les lignes suivantes :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-conf" data-lang="conf">store_id_program /usr/local/squid/store-id.pl /usr/local/squid/store_id_db
store_id_children 5 startup=1</code></pre></div>
<ul>
<li><code>store_id_program</code> est le chemin vers le programme perl avec en argument le fichier de mapping des urls</li>
<li><code>store_id_children</code> permet de paramétrer les sous-process, 5 max, 1 au départ.</li>
</ul>

<p>Reste enfin le fichier de mappin d&rsquo;URL a ajouter. Il est sous la forme :
 * Regex de l&rsquo;url
 * tabulation
 * URL re-ecrite</p>

<p>Exemple :</p>

<pre><code>^http:\/\/download\.oracle\.com\/otn\-pub\/java\/([a-zA-Z0-9\/\.\-\_]+\.(tar\.gz))	http://download.oracle.com/otn-pub/java/$1
</code></pre>

<p>Attention que la tabulation ne soit pas remplacer par défaut par votre éditeur de texte. Pour être sûr, on peut utiliser
cette commande :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">cat dbfile | sed -r -e <span style="color:#e6db74">&#39;s/\s+/\t/g&#39;</span> |sed <span style="color:#e6db74">&#39;/^\#/d&#39;</span> &gt;cleaned_db_file</code></pre></div>
<p>Cela va nettoyer le fichier de base pour être certain qu&rsquo;il soit bon. Tout un listing d&rsquo;url est donné en exemple dans la
doc Squid : <a href="http://wiki.squid-cache.org/Features/StoreID/DB">http://wiki.squid-cache.org/Features/StoreID/DB</a></p>



    
    
  </section>

  
      <aside class="toc">
        
      </aside>
  

</article>

<script src="/js/clipboard.min.js"></script>

<link href="/css/featherlight.min.css" rel="stylesheet">
<script src="/js/featherlight.min.js"></script>



<script src="/js/search.js"></script>


    
    

    
  </body>
</html>
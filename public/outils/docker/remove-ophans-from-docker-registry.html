<!DOCTYPE html>
<html>
  <head>
    <title>
    Remove ophans from docker registry - wiki.ght1pc9kc.fr
</title>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="generator" content="Hugo 0.40.2" />
<title>Remove ophans from docker registry :: wiki.ght1pc9kc.fr</title>
<link rel="shortcut icon" href="/images/logo.png" type="image/x-icon" />
<link href="/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/nucleus.css" rel="stylesheet">
<link href="/css/style.css" rel="stylesheet">
<link rel="stylesheet" href="/css/bootstrap.min.css">
<script src="/js/jquery-2.x.min.js"></script>
<script type="text/javascript">
      var baseurl = "";
</script>
  </head>
  <body data-url="/outils/docker/remove-ophans-from-docker-registry.html">

    <header>
  
  <div class="logo">
	<a class="baselink" href="">
	    <img src="/images/logo.png" alt="wiki.ght1pc9kc.fr"/> wiki.ght1pc9kc.fr
	</a>
</div>
<span class="spacer">&nbsp;</span>
<div class="navbar-right">
    <form class="navbar-form navbar-left" action="/search.html" method="get">
       <input id="search-box" name="query" placeholder="Search..." autocomplete="off" spellcheck="false" dir="auto" type="text">
    </form>
</div>
</header>
<article>
  <aside class="menu">
    <div class="list-group">
        <a href="/cuisine.html" class="list-group-item list-group-item-action active">Cuisine</a>
    </div>
    <div class="list-group">
        <a href="/misc.html" class="list-group-item list-group-item-action active">Divers</a>
    </div>
    <div class="list-group">
        <a href="/development.html" class="list-group-item list-group-item-action active">Développement</a>
        <a href="/development/dotnet.html" class="list-group-item list-group-item-action ">.Net</a>
        <a href="/development/gwt.html" class="list-group-item list-group-item-action ">GWT</a>
        <a href="/development/java.html" class="list-group-item list-group-item-action ">Java</a>
        <a href="/development/javascript.html" class="list-group-item list-group-item-action ">Javascript</a>
        <a href="/development/spring.html" class="list-group-item list-group-item-action ">Spring</a>
    </div>
    <div class="list-group">
        <a href="/linux.html" class="list-group-item list-group-item-action active">Linux</a>
        <a href="/linux/administration.html" class="list-group-item list-group-item-action ">Administration</a>
        <a href="/linux/divers.html" class="list-group-item list-group-item-action ">Divers</a>
        <a href="/linux/gnomeshell.html" class="list-group-item list-group-item-action ">GnomeShell</a>
        <a href="/linux/network.html" class="list-group-item list-group-item-action ">Réseau</a>
        <a href="/linux/shell.html" class="list-group-item list-group-item-action ">Shell</a>
    </div>
    <div class="list-group">
        <a href="/outils.html" class="list-group-item list-group-item-action active">Outils</a>
        <a href="/outils/ansible.html" class="list-group-item list-group-item-action ">Ansible</a>
        <a href="/outils/docker.html" class="list-group-item list-group-item-action ">Docker</a>
        <a href="/outils/eclipse.html" class="list-group-item list-group-item-action ">Eclipse</a>
        <a href="/outils/git.html" class="list-group-item list-group-item-action ">Git</a>
        <a href="/outils/intellij.html" class="list-group-item list-group-item-action ">IntelliJ</a>
        <a href="/outils/latex.html" class="list-group-item list-group-item-action ">LaTeX</a>
        <a href="/outils/vmware.html" class="list-group-item list-group-item-action ">VMWare</a>
    </div>
    <div class="list-group">
        <a href="/serveurs.html" class="list-group-item list-group-item-action active">Serveur</a>
        <a href="/serveurs/http.html" class="list-group-item list-group-item-action ">HTTP</a>
        <a href="/serveurs/jboss.html" class="list-group-item list-group-item-action ">JBoss</a>
        <a href="/serveurs/mysql.html" class="list-group-item list-group-item-action ">MySQL</a>
        <a href="/serveurs/neo4j.html" class="list-group-item list-group-item-action ">Neo4J</a>
        <a href="/serveurs/oracle.html" class="list-group-item list-group-item-action ">Oracle</a>
        <a href="/serveurs/teradata.html" class="list-group-item list-group-item-action ">TeraData</a>
    </div>


  </aside>
  <section class="page">

    <h1>Remove ophans from docker registry</h1>
    
    

    <p>Il est compliqué de nettoyer un registry Docker (avant sa version 2.0 en tout cas). Voici un script qui supprime les images orpheline dans le registry.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>
JQPATH<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>which jq<span style="color:#66d9ef">)</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;x</span>$JQPATH<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;x&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
  echo <span style="color:#e6db74">&#34;Couldn&#39;t find jq executable.&#34;</span> <span style="color:#ae81ff">1</span>&gt;&amp;<span style="color:#ae81ff">2</span>
  exit <span style="color:#ae81ff">2</span>
<span style="color:#66d9ef">fi</span>

set -eu
shopt -s nullglob

readonly base_dir<span style="color:#f92672">=</span>/data/docker_registry_backup/registry/
readonly output_dir<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>mktemp -d -t trace-images-XXXX<span style="color:#66d9ef">)</span>
readonly jq<span style="color:#f92672">=</span>$JQPATH

readonly repository_dir<span style="color:#f92672">=</span>$base_dir/repositories
readonly image_dir<span style="color:#f92672">=</span>$base_dir/images

readonly all_images<span style="color:#f92672">=</span>$output_dir/all
readonly used_images<span style="color:#f92672">=</span>$output_dir/used
readonly unused_images<span style="color:#f92672">=</span>$output_dir/unused

<span style="color:#66d9ef">function</span> info<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    echo -e <span style="color:#e6db74">&#34;\nArtifacts available in </span>$output_dir<span style="color:#e6db74">&#34;</span>
<span style="color:#f92672">}</span>
trap info EXIT ERR INT

<span style="color:#66d9ef">function</span> image_history<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    local readonly image_hash<span style="color:#f92672">=</span>$1
    $jq <span style="color:#e6db74">&#39;.[]&#39;</span> $image_dir/$image_hash/ancestry | tr -d  <span style="color:#e6db74">&#39;&#34;&#39;</span>
<span style="color:#f92672">}</span>

echo <span style="color:#e6db74">&#34;Collecting orphan images&#34;</span>
<span style="color:#66d9ef">for</span> library in $repository_dir/*; <span style="color:#66d9ef">do</span>
    echo <span style="color:#e6db74">&#34;Library </span><span style="color:#66d9ef">$(</span>basename $library<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> &gt;&amp;<span style="color:#ae81ff">2</span>

    <span style="color:#66d9ef">for</span> repo in $library/*; <span style="color:#66d9ef">do</span>
        echo <span style="color:#e6db74">&#34; Repo </span><span style="color:#66d9ef">$(</span>basename $repo<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> &gt;&amp;<span style="color:#ae81ff">2</span>

        <span style="color:#66d9ef">for</span> tag in $repo/tag_*; <span style="color:#66d9ef">do</span>
            echo <span style="color:#e6db74">&#34;  Tag </span><span style="color:#66d9ef">$(</span>basename $tag<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> &gt;&amp;<span style="color:#ae81ff">2</span>

            tagged_image<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>cat $tag<span style="color:#66d9ef">)</span>
            image_history $tagged_image
        <span style="color:#66d9ef">done</span>
    <span style="color:#66d9ef">done</span>
<span style="color:#66d9ef">done</span> | sort | uniq &gt; $used_images

ls $image_dir &gt; $all_images

grep -v -F -f $used_images $all_images &gt; $unused_images

readonly all_image_count<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>wc -l $all_images | awk <span style="color:#e6db74">&#39;{print $1}&#39;</span><span style="color:#66d9ef">)</span>
readonly used_image_count<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>wc -l $used_images | awk <span style="color:#e6db74">&#39;{print $1}&#39;</span><span style="color:#66d9ef">)</span>
readonly unused_image_count<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>wc -l $unused_images | awk <span style="color:#e6db74">&#39;{print $1}&#39;</span><span style="color:#66d9ef">)</span>
readonly unused_image_size<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>cd $image_dir; du -hc <span style="color:#66d9ef">$(</span>cat $unused_images<span style="color:#66d9ef">)</span> | tail -n1 | cut -f1<span style="color:#66d9ef">)</span>

echo <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>all_image_count<span style="color:#e6db74">}</span><span style="color:#e6db74"> images, </span><span style="color:#e6db74">${</span>used_image_count<span style="color:#e6db74">}</span><span style="color:#e6db74"> used, </span><span style="color:#e6db74">${</span>unused_image_count<span style="color:#e6db74">}</span><span style="color:#e6db74"> unused&#34;</span>
echo <span style="color:#e6db74">&#34;Unused images consume </span><span style="color:#e6db74">${</span>unused_image_size<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>

echo -e <span style="color:#e6db74">&#34;\nTrimming _index_images...&#34;</span>
readonly unused_images_flatten<span style="color:#f92672">=</span>$output_dir/unused.flatten
cat $unused_images | sed -e <span style="color:#e6db74">&#39;s/\(.*\)/\&#34;\1\&#34; /&#39;</span> | tr -d <span style="color:#e6db74">&#34;\n&#34;</span> &gt; $unused_images_flatten

<span style="color:#66d9ef">for</span> library in $repository_dir/*; <span style="color:#66d9ef">do</span>
    echo <span style="color:#e6db74">&#34;Library </span><span style="color:#66d9ef">$(</span>basename $library<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> &gt;&amp;<span style="color:#ae81ff">2</span>

    <span style="color:#66d9ef">for</span> repo in $library/*; <span style="color:#66d9ef">do</span>
        echo <span style="color:#e6db74">&#34; Repo </span><span style="color:#66d9ef">$(</span>basename $repo<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> &gt;&amp;<span style="color:#ae81ff">2</span>
        mkdir -p <span style="color:#e6db74">&#34;</span>$output_dir<span style="color:#e6db74">/</span><span style="color:#66d9ef">$(</span>basename $repo<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
        jq <span style="color:#e6db74">&#39;.&#39;</span> <span style="color:#e6db74">&#34;</span>$repo<span style="color:#e6db74">/_index_images&#34;</span> &gt; <span style="color:#e6db74">&#34;</span>$output_dir<span style="color:#e6db74">/</span><span style="color:#66d9ef">$(</span>basename $repo<span style="color:#66d9ef">)</span><span style="color:#e6db74">/_index_images.old&#34;</span>
        jq -s <span style="color:#e6db74">&#39;.[0] - [ .[1:][] | {id: .} ]&#39;</span> <span style="color:#e6db74">&#34;</span>$repo<span style="color:#e6db74">/_index_images&#34;</span> $unused_images_flatten &gt; <span style="color:#e6db74">&#34;</span>$output_dir<span style="color:#e6db74">/</span><span style="color:#66d9ef">$(</span>basename $repo<span style="color:#66d9ef">)</span><span style="color:#e6db74">/_index_images&#34;</span>
        sudo cp <span style="color:#e6db74">&#34;</span>$output_dir<span style="color:#e6db74">/</span><span style="color:#66d9ef">$(</span>basename $repo<span style="color:#66d9ef">)</span><span style="color:#e6db74">/_index_images&#34;</span> <span style="color:#e6db74">&#34;</span>$repo<span style="color:#e6db74">/_index_images&#34;</span>
    <span style="color:#66d9ef">done</span>
<span style="color:#66d9ef">done</span>

echo -e <span style="color:#e6db74">&#34;\nRemoving images&#34;</span>
cat $unused_images | xargs -I<span style="color:#f92672">{}</span> rm -rf $image_dir/<span style="color:#f92672">{}</span></code></pre></div>


    
    
  </section>

  
      <aside class="toc">
        
      </aside>
  

</article>

<script src="/js/clipboard.min.js"></script>

<link href="/css/featherlight.min.css" rel="stylesheet">
<script src="/js/featherlight.min.js"></script>



<script src="/js/search.js"></script>


    
    

    
  </body>
</html>
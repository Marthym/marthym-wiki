<!DOCTYPE html>
<html>
  <head>
    <title>
    1s de cache contre le downtime - wiki.ght1pc9kc.fr
</title>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="generator" content="Hugo 0.40.2" />
<title>1s de cache contre le downtime :: wiki.ght1pc9kc.fr</title>
<link rel="shortcut icon" href="/images/logo.png" type="image/x-icon" />
<link href="/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/nucleus.css" rel="stylesheet">
<link href="/css/style.css" rel="stylesheet">
<link rel="stylesheet" href="/css/bootstrap.min.css">
<script src="/js/jquery-2.x.min.js"></script>
<script type="text/javascript">
      var baseurl = "";
</script>
  </head>
  <body data-url="/serveurs/http/1s-de-cache-nginx.html">

    <header>
  
  <div class="logo">
	<a class="baselink" href="">
	    <img src="/images/logo.png" alt="wiki.ght1pc9kc.fr"/> wiki.ght1pc9kc.fr
	</a>
</div>
<span class="spacer">&nbsp;</span>
<div class="navbar-right">
    <form class="navbar-form navbar-left" action="/search.html" method="get">
       <input id="search-box" name="query" placeholder="Search..." autocomplete="off" spellcheck="false" dir="auto" type="text">
    </form>
</div>
</header>
<article>
  <aside class="menu">
    <div class="list-group">
        <a href="/cuisine.html" class="list-group-item list-group-item-action active">Cuisine</a>
    </div>
    <div class="list-group">
        <a href="/misc.html" class="list-group-item list-group-item-action active">Divers</a>
    </div>
    <div class="list-group">
        <a href="/development.html" class="list-group-item list-group-item-action active">Développement</a>
        <a href="/development/dotnet.html" class="list-group-item list-group-item-action ">.Net</a>
        <a href="/development/gwt.html" class="list-group-item list-group-item-action ">GWT</a>
        <a href="/development/java.html" class="list-group-item list-group-item-action ">Java</a>
        <a href="/development/javascript.html" class="list-group-item list-group-item-action ">Javascript</a>
        <a href="/development/spring.html" class="list-group-item list-group-item-action ">Spring</a>
    </div>
    <div class="list-group">
        <a href="/linux.html" class="list-group-item list-group-item-action active">Linux</a>
        <a href="/linux/administration.html" class="list-group-item list-group-item-action ">Administration</a>
        <a href="/linux/divers.html" class="list-group-item list-group-item-action ">Divers</a>
        <a href="/linux/gnomeshell.html" class="list-group-item list-group-item-action ">GnomeShell</a>
        <a href="/linux/network.html" class="list-group-item list-group-item-action ">Réseau</a>
        <a href="/linux/shell.html" class="list-group-item list-group-item-action ">Shell</a>
    </div>
    <div class="list-group">
        <a href="/outils.html" class="list-group-item list-group-item-action active">Outils</a>
        <a href="/outils/ansible.html" class="list-group-item list-group-item-action ">Ansible</a>
        <a href="/outils/docker.html" class="list-group-item list-group-item-action ">Docker</a>
        <a href="/outils/eclipse.html" class="list-group-item list-group-item-action ">Eclipse</a>
        <a href="/outils/git.html" class="list-group-item list-group-item-action ">Git</a>
        <a href="/outils/intellij.html" class="list-group-item list-group-item-action ">IntelliJ</a>
        <a href="/outils/latex.html" class="list-group-item list-group-item-action ">LaTeX</a>
        <a href="/outils/vmware.html" class="list-group-item list-group-item-action ">VMWare</a>
    </div>
    <div class="list-group">
        <a href="/serveurs.html" class="list-group-item list-group-item-action active">Serveur</a>
        <a href="/serveurs/http.html" class="list-group-item list-group-item-action ">HTTP</a>
        <a href="/serveurs/jboss.html" class="list-group-item list-group-item-action ">JBoss</a>
        <a href="/serveurs/mysql.html" class="list-group-item list-group-item-action ">MySQL</a>
        <a href="/serveurs/neo4j.html" class="list-group-item list-group-item-action ">Neo4J</a>
        <a href="/serveurs/oracle.html" class="list-group-item list-group-item-action ">Oracle</a>
        <a href="/serveurs/teradata.html" class="list-group-item list-group-item-action ">TeraData</a>
    </div>


  </aside>
  <section class="page">

    <h1>1s de cache contre le downtime</h1>
    
    

    

<p><em>Copie depuis <a href="https://lord.re/posts/60-cache-proxy-nginx/">https://lord.re/posts/60-cache-proxy-nginx/</a> de lord@lord.re</em></p>

<p>Depuis que mon serveur ne me sert plus de routeur il m’arrive de le couper de temps à autres. Et pourtant mon site reste accessible. J’ai en fait, sur mon routeur, installé un container avec un nginx qui tourne et qui proxy. Les connexions se font donc via le nginx du routeur qui sert de cache quand le vrai serveur ne répond pas. Mais histoire de ne pas avoir de contenu pas à jour mais toujours d’une fraîcheur exemplaire je me contente d’un cache de maximum 1seconde.</p>

<h2 id="1s-de-cache">1s de cache</h2>

<p>Oui oui une seconde suffit. Bon dans mon cas c’est overkill car mon site est statique mais pour des sites dynamiques à fort trafic c’est clairement valable. Fournir un contenu vieu d’un seconde n’est généralement pas gênant. Par contre la différence de perf est assez énormissime.</p>

<p>Mais au delà de ça, si on rajoute deux trois options de configuration, vous pourrez vous prémunir des downtime (ce que je recherchais surtout).</p>

<p>Bon on va définir le_cache qui va être l’endroit où seront stockées nos données en cache : <code>proxy_cache_path /var/www/cache keys_zone=le_cache:1m max_size=20m inactive=10d use_temp_path=off;</code></p>

<p>Bon sur la machine qui va vous servir de proxy vous allez dans la conf du bel nginx /etc/conf/nginx/nginx.conf vous ajoutez la conf du vhost:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nginx" data-lang="nginx"><span style="color:#66d9ef">server</span> {
        <span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span>;
        <span style="color:#f92672">listen</span> <span style="color:#ae81ff">443</span> <span style="color:#e6db74">ssl</span> <span style="color:#e6db74">http2</span>;
        <span style="color:#f92672">server_name</span> <span style="color:#e6db74">www.lordtoniok.com</span> <span style="color:#e6db74">lordtoniok.com</span> <span style="color:#e6db74">bender.lordtoniok.com</span> <span style="color:#e6db74">www.lord.re</span> <span style="color:#e6db74">lord.re</span> <span style="color:#e6db74">bender.lord.re</span> <span style="color:#e6db74">_</span>;
        <span style="color:#f92672">include</span> <span style="color:#e6db74">ssl.conf</span>;
        <span style="color:#f92672">ssl_certificate</span> <span style="color:#e6db74">/etc/ssl/acme/lord.re/fullchain.pem</span>;
        <span style="color:#f92672">ssl_certificate_key</span> <span style="color:#e6db74">/etc/ssl/acme/private/lord.re/privkey.pem</span>;
        <span style="color:#f92672">location</span> <span style="color:#e6db74">/.well-known/acme-challenge</span> {
            <span style="color:#f92672">alias</span> <span style="color:#e6db74">/var/www/acme</span>;
        }
        <span style="color:#f92672">location</span> <span style="color:#e6db74">/</span> {
                <span style="color:#f92672">proxy_cache</span> <span style="color:#e6db74">le_cache</span>;
                <span style="color:#f92672">proxy_pass</span> <span style="color:#e6db74">http://10.0.0.1</span>;
                <span style="color:#f92672">proxy_cache_lock</span> <span style="color:#66d9ef">on</span>;
                <span style="color:#f92672">proxy_cache_use_stale</span> <span style="color:#e6db74">updating</span> <span style="color:#e6db74">error</span> <span style="color:#e6db74">timeout</span> <span style="color:#e6db74">http_502</span> <span style="color:#e6db74">http_503</span>;
                <span style="color:#f92672">proxy_cache_valid</span> <span style="color:#ae81ff">200</span> <span style="color:#e6db74">1s</span>;
                <span style="color:#f92672">add_header</span> <span style="color:#e6db74">X-Cache-Status</span> $upstream_cache_status;
                <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $host;
                <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-IP</span> $remote_addr;
                <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;
              <span style="color:#75715e"># proxy_buffering off;
</span><span style="color:#75715e"></span>        }
}</code></pre></div>
<p>La magie se trouve dans le <code>proxy_cache_use_stale</code> qui fait en sorte d’envoyer le cache si le serveur upstream ne répond pas.</p>

<p>Désormais je peux couper le serveur sans que ça ne se voit. Ça peut permettre de mettre à jour l’esprit libre. Sur un site dynamique ça peut énormément booster les perfs sans trop de détriments (surtout avec juste 1s de cache).</p>

<p>Le <code>proxy_buffering off;</code> n’est peut-être pas adapté à votre cas mais si je ne le met pas, lorsqu’un bienveillant internaute tente de récupérer un fichier un poil gros (plus de quelques Mo) bha ça déconne de partout car la machine a peu de ram, donc ça rentre pas en ram, donc nginx tente de fouttre ça dans le cache, mais comme j’ai restreint le cache à 20Mo… bha si ça rentre pas dedans ça merdoie et ça n’envoi plus les données. Voilà voilà. Donc là je l’ai mis en commentaire car cet exemple n’est qu’un morceau de ma conf complète mais je voulais quand même vous présenter cette option.</p>



    
    
  </section>

  
      <aside class="toc">
        <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#1s-de-cache">1s de cache</a></li>
</ul></li>
</ul>
</nav>
      </aside>
  

</article>

<script src="/js/clipboard.min.js"></script>

<link href="/css/featherlight.min.css" rel="stylesheet">
<script src="/js/featherlight.min.js"></script>



<script src="/js/search.js"></script>


    
    

    
  </body>
</html>
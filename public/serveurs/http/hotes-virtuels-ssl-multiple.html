<!DOCTYPE html>
<html>
  <head>
    <title>
    Hôtes virtuels SSL multiples - wiki.ght1pc9kc.fr
</title>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="generator" content="Hugo 0.40.2" />
<title>Hôtes virtuels SSL multiples :: wiki.ght1pc9kc.fr</title>
<link rel="shortcut icon" href="/images/logo.png" type="image/x-icon" />
<link href="/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/nucleus.css" rel="stylesheet">
<link href="/css/style.css" rel="stylesheet">
<link rel="stylesheet" href="/css/bootstrap.min.css">
<script src="/js/jquery-2.x.min.js"></script>
<script type="text/javascript">
      var baseurl = "";
</script>
  </head>
  <body data-url="/serveurs/http/hotes-virtuels-ssl-multiple.html">

    <header>
  
  <div class="logo">
	<a class="baselink" href="">
	    <img src="/images/logo.png" alt="wiki.ght1pc9kc.fr"/> wiki.ght1pc9kc.fr
	</a>
</div>
<span class="spacer">&nbsp;</span>
<div class="navbar-right">
    <form class="navbar-form navbar-left" action="/search.html" method="get">
       <input id="search-box" name="query" placeholder="Search..." autocomplete="off" spellcheck="false" dir="auto" type="text">
    </form>
</div>
</header>
<article>
  <aside class="menu">
    <div class="list-group">
        <a href="/cuisine.html" class="list-group-item list-group-item-action active">Cuisine</a>
    </div>
    <div class="list-group">
        <a href="/misc.html" class="list-group-item list-group-item-action active">Divers</a>
    </div>
    <div class="list-group">
        <a href="/development.html" class="list-group-item list-group-item-action active">Développement</a>
        <a href="/development/dotnet.html" class="list-group-item list-group-item-action ">.Net</a>
        <a href="/development/gwt.html" class="list-group-item list-group-item-action ">GWT</a>
        <a href="/development/java.html" class="list-group-item list-group-item-action ">Java</a>
        <a href="/development/javascript.html" class="list-group-item list-group-item-action ">Javascript</a>
        <a href="/development/spring.html" class="list-group-item list-group-item-action ">Spring</a>
    </div>
    <div class="list-group">
        <a href="/linux.html" class="list-group-item list-group-item-action active">Linux</a>
        <a href="/linux/administration.html" class="list-group-item list-group-item-action ">Administration</a>
        <a href="/linux/divers.html" class="list-group-item list-group-item-action ">Divers</a>
        <a href="/linux/gnomeshell.html" class="list-group-item list-group-item-action ">GnomeShell</a>
        <a href="/linux/network.html" class="list-group-item list-group-item-action ">Réseau</a>
        <a href="/linux/shell.html" class="list-group-item list-group-item-action ">Shell</a>
    </div>
    <div class="list-group">
        <a href="/outils.html" class="list-group-item list-group-item-action active">Outils</a>
        <a href="/outils/ansible.html" class="list-group-item list-group-item-action ">Ansible</a>
        <a href="/outils/docker.html" class="list-group-item list-group-item-action ">Docker</a>
        <a href="/outils/eclipse.html" class="list-group-item list-group-item-action ">Eclipse</a>
        <a href="/outils/git.html" class="list-group-item list-group-item-action ">Git</a>
        <a href="/outils/intellij.html" class="list-group-item list-group-item-action ">IntelliJ</a>
        <a href="/outils/latex.html" class="list-group-item list-group-item-action ">LaTeX</a>
        <a href="/outils/vmware.html" class="list-group-item list-group-item-action ">VMWare</a>
    </div>
    <div class="list-group">
        <a href="/serveurs.html" class="list-group-item list-group-item-action active">Serveur</a>
        <a href="/serveurs/http.html" class="list-group-item list-group-item-action ">HTTP</a>
        <a href="/serveurs/jboss.html" class="list-group-item list-group-item-action ">JBoss</a>
        <a href="/serveurs/mysql.html" class="list-group-item list-group-item-action ">MySQL</a>
        <a href="/serveurs/neo4j.html" class="list-group-item list-group-item-action ">Neo4J</a>
        <a href="/serveurs/oracle.html" class="list-group-item list-group-item-action ">Oracle</a>
        <a href="/serveurs/teradata.html" class="list-group-item list-group-item-action ">TeraData</a>
    </div>


  </aside>
  <section class="page">

    <h1>Hôtes virtuels SSL multiples</h1>
    
    

    

<p>Alors on trouve sur internet une flopper de tuto pour configurer sous Apache des VirtualHost SSL multiple.
On a beau les lire et les re-lire, essayer des centaines de combinaisons pour chaque fichier de configuration, on en vient
toujours au même résultat : C&rsquo;est le premier vhost qui est retourné !</p>

<h2 id="explication-technique">Explication technique</h2>

<p>Ce que la plus part des tuto ne dit pas c&rsquo;est déjà qu&rsquo;il faut avoir des version d&rsquo;Apache et de OpenSSL très récente
pour que ça ai une chance de fonctionné. Mais même avec ça, je n&rsquo;ai pas réussi à le faire fonctionner.</p>

<p>La raison technique a cette impossibilité est la suivante :</p>

<pre><code>The reason is that the SSL protocol is a separate layer which encapsulates the HTTP protocol. So the SSL session is a
separate transaction, that takes place before the HTTP session has begun. The server receives an SSL request on IP
address X and port Y (usually 443). Since the SSL request did not contain any Host: field, the server had no way to
decide which SSL virtual host to use. Usually, it just used the first one it found which matched the port and IP
address specified.
</code></pre>

<p>Du coup, quand ça ne fonctionne pas, deux choix reste possible pour contourner le problème :</p>

<ul>
<li>Utiliser plusieurs adresse IP</li>
<li>Utiliser plusieurs ports</li>
</ul>

<h2 id="solution">Solution</h2>

<p>La solution pas trop compliqué est donc d&rsquo;utiliser plusieurs port, mais ça demande d&rsquo;avoir un frontal qui va faire la
redirection vers les différents port selon le nom de domaine demandé. Mais dans le cas des phases de développement est
pas toujours pratique ni facile d&rsquo;avoir ce genre d’architecture en place pour de simple développements.</p>

<p>Du coup on va configurer Apache sur plusieurs adresse IP. Par contre cette solution ne fonctionne un serveur Apache
Windows (ou du moins je sais pas comment) car il est nécessaire de pouvoir configurer plusieurs adresse IP sur une même
interface réseau.</p>

<h3 id="configuration-système">Configuration système</h3>

<p>Suivre le tuto pour [[Avoir plusieurs adresses IP sur la même interface|Avoir-plusieurs-adresses-IP-sur-la-meme-interface]] &hellip;</p>

<h3 id="configuration-apache">Configuration Apache</h3>

<h4 id="fichier-d-écoute">Fichier d&rsquo;écoute</h4>

<p>Ensuite, une fois que l&rsquo;on a plusieurs adresse IP, il faut demander à Apache d&rsquo;écouter sur ces adresse. Dans <code>/etc/apache2/port.conf</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-apache" data-lang="apache"><span style="color:#f92672">&lt;IfModule</span> <span style="color:#e6db74">mod_ssl.c</span><span style="color:#f92672">&gt;</span>
    <span style="color:#75715e"># If you add NameVirtualHost *:443 here, you will also have to change</span>
    <span style="color:#75715e"># the VirtualHost statement in /etc/apache2/sites-available/default-ssl</span>
    <span style="color:#75715e"># to &lt;VirtualHost *:443&gt;</span>
    <span style="color:#75715e"># Server Name Indication for SSL named virtual hosts is currently not</span>
    <span style="color:#75715e"># supported by MSIE on Windows XP.</span>

    NameVirtualHost <span style="color:#ae81ff">172.16.139.21</span>:443
    NameVirtualHost <span style="color:#ae81ff">172.16.139.22</span>:443
    Listen <span style="color:#ae81ff">443</span>
<span style="color:#f92672">&lt;/IfModule&gt;</span></code></pre></div>
<p>On n&rsquo;utilise pas la notation <code>*:443</code> car il nous demanderait lors du démarrage un vhost par défaut pour <code>*:443</code> et ce
n&rsquo;est pas ce que l&rsquo;on veut faire.</p>

<h4 id="fichiers-des-hôtes-virtuel">Fichiers des hôtes virtuel</h4>

<p>Ensuite dans <code>/etc/apache2/sites-available/</code> on va créer un premier fichier pour le premier serveur virtuel :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-apache" data-lang="apache"><span style="color:#f92672">&lt;IfModule</span> <span style="color:#e6db74">mod_ssl.c</span><span style="color:#f92672">&gt;</span>
<span style="color:#f92672">&lt;VirtualHost</span> <span style="color:#e6db74">172.16.139.21:443</span><span style="color:#f92672">&gt;</span>
        ServerAdmin webmaster@dev.local
        ServerName mnt.dev.local

        DocumentRoot <span style="color:#e6db74">/var/www/dev/mnt/public</span>
        <span style="color:#f92672">&lt;Directory</span> <span style="color:#e6db74">/</span><span style="color:#f92672">&gt;</span>
                Options FollowSymLinks
                AllowOverride <span style="color:#66d9ef">None</span>
        <span style="color:#f92672">&lt;/Directory&gt;</span>

...

<span style="color:#f92672">&lt;/VirtualHost&gt;</span>
<span style="color:#f92672">&lt;/IfModule&gt;</span></code></pre></div>
<p>Et un fichier deuxième fichier pour le deuxième hôte :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-apache" data-lang="apache"><span style="color:#f92672">&lt;IfModule</span> <span style="color:#e6db74">mod_ssl.c</span><span style="color:#f92672">&gt;</span>
<span style="color:#f92672">&lt;VirtualHost</span> <span style="color:#e6db74">172.16.139.22:443</span><span style="color:#f92672">&gt;</span>
        ServerAdmin webmaster@dev.local
        ServerName www.recette.local
        ServerAlias mnt.recette.local mgp.recette.local

        DocumentRoot <span style="color:#e6db74">/var/www/recette/public</span>
        <span style="color:#f92672">&lt;Directory</span> <span style="color:#e6db74">/</span><span style="color:#f92672">&gt;</span>
                Options FollowSymLinks
                AllowOverride <span style="color:#66d9ef">None</span>
        <span style="color:#f92672">&lt;/Directory&gt;</span>

...

<span style="color:#f92672">&lt;/VirtualHost&gt;</span>
<span style="color:#f92672">&lt;/IfModule&gt;</span></code></pre></div>
<p>Je ne m&rsquo;attarde pas sur les différentes options pour le SSL ou les droits des répertoires, le sujet du tuto n&rsquo;est pas là.
Le point d’intérêt se trouve dans les premières lignes de chaque fichier. On remarque que l&rsquo;on utilise les adresse IP
au lieu de &ldquo;*&ldquo;.<br/>
Autre point intéressant dans le deuxième fichier on définit des alias qui vont permettre d&rsquo;arriver sur le même serveur
SSL avec des noms de sous-domaine différent.</p>

<h3 id="pour-finir">Pour finir</h3>

<p>Pour finir, on active les deux sites :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">a2ensite mnt.dev.local-ssl
a2ensite recette.local-ssl</code></pre></div>
<p>Puis on redémarre le serveur Apache :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">service apache2 reload</code></pre></div>
<h2 id="liens">Liens</h2>

<ul>
<li><a href="https://httpd.apache.org/docs/2.2/ssl/ssl_faq.html#vhosts2">https://httpd.apache.org/docs/2.2/ssl/ssl_faq.html#vhosts2</a></li>
</ul>



    
    
  </section>

  
      <aside class="toc">
        <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#explication-technique">Explication technique</a></li>
<li><a href="#solution">Solution</a>
<ul>
<li><a href="#configuration-système">Configuration système</a></li>
<li><a href="#configuration-apache">Configuration Apache</a>
<ul>
<li><a href="#fichier-d-écoute">Fichier d&rsquo;écoute</a></li>
<li><a href="#fichiers-des-hôtes-virtuel">Fichiers des hôtes virtuel</a></li>
</ul></li>
<li><a href="#pour-finir">Pour finir</a></li>
</ul></li>
<li><a href="#liens">Liens</a></li>
</ul></li>
</ul>
</nav>
      </aside>
  

</article>

<script src="/js/clipboard.min.js"></script>

<link href="/css/featherlight.min.css" rel="stylesheet">
<script src="/js/featherlight.min.js"></script>



<script src="/js/search.js"></script>


    
    

    
  </body>
</html>
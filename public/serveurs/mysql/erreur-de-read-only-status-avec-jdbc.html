<!DOCTYPE html>
<html>
  <head>
    <title>
    Erreur de read-only status avec JDBC - wiki.ght1pc9kc.fr
</title>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="generator" content="Hugo 0.40.2" />
<title>Erreur de read-only status avec JDBC :: wiki.ght1pc9kc.fr</title>
<link rel="shortcut icon" href="/images/logo.png" type="image/x-icon" />
<link href="/css/font-awesome.min.css" rel="stylesheet">
<link href="/css/nucleus.css" rel="stylesheet">
<link href="/css/style.css" rel="stylesheet">
<link rel="stylesheet" href="/css/bootstrap.min.css">
<script src="/js/jquery-2.x.min.js"></script>
<script type="text/javascript">
      var baseurl = "";
</script>
  </head>
  <body data-url="/serveurs/mysql/erreur-de-read-only-status-avec-jdbc.html">

    <header>
  
  <div class="logo">
	<a class="baselink" href="">
	    <img src="/images/logo.png" alt="wiki.ght1pc9kc.fr"/> wiki.ght1pc9kc.fr
	</a>
</div>
<span class="spacer">&nbsp;</span>
<div class="navbar-right">
    <form class="navbar-form navbar-left" action="/search.html" method="get">
       <input id="search-box" name="query" placeholder="Search..." autocomplete="off" spellcheck="false" dir="auto" type="text">
    </form>
</div>
</header>
<article>
  <aside class="menu">
    <div class="list-group">
        <a href="/cuisine.html" class="list-group-item list-group-item-action active">Cuisine</a>
    </div>
    <div class="list-group">
        <a href="/misc.html" class="list-group-item list-group-item-action active">Divers</a>
    </div>
    <div class="list-group">
        <a href="/development.html" class="list-group-item list-group-item-action active">Développement</a>
        <a href="/development/dotnet.html" class="list-group-item list-group-item-action ">.Net</a>
        <a href="/development/gwt.html" class="list-group-item list-group-item-action ">GWT</a>
        <a href="/development/java.html" class="list-group-item list-group-item-action ">Java</a>
        <a href="/development/javascript.html" class="list-group-item list-group-item-action ">Javascript</a>
        <a href="/development/spring.html" class="list-group-item list-group-item-action ">Spring</a>
    </div>
    <div class="list-group">
        <a href="/linux.html" class="list-group-item list-group-item-action active">Linux</a>
        <a href="/linux/administration.html" class="list-group-item list-group-item-action ">Administration</a>
        <a href="/linux/divers.html" class="list-group-item list-group-item-action ">Divers</a>
        <a href="/linux/gnomeshell.html" class="list-group-item list-group-item-action ">GnomeShell</a>
        <a href="/linux/network.html" class="list-group-item list-group-item-action ">Réseau</a>
        <a href="/linux/shell.html" class="list-group-item list-group-item-action ">Shell</a>
    </div>
    <div class="list-group">
        <a href="/outils.html" class="list-group-item list-group-item-action active">Outils</a>
        <a href="/outils/ansible.html" class="list-group-item list-group-item-action ">Ansible</a>
        <a href="/outils/docker.html" class="list-group-item list-group-item-action ">Docker</a>
        <a href="/outils/eclipse.html" class="list-group-item list-group-item-action ">Eclipse</a>
        <a href="/outils/git.html" class="list-group-item list-group-item-action ">Git</a>
        <a href="/outils/intellij.html" class="list-group-item list-group-item-action ">IntelliJ</a>
        <a href="/outils/latex.html" class="list-group-item list-group-item-action ">LaTeX</a>
        <a href="/outils/vmware.html" class="list-group-item list-group-item-action ">VMWare</a>
    </div>
    <div class="list-group">
        <a href="/serveurs.html" class="list-group-item list-group-item-action active">Serveur</a>
        <a href="/serveurs/http.html" class="list-group-item list-group-item-action ">HTTP</a>
        <a href="/serveurs/jboss.html" class="list-group-item list-group-item-action ">JBoss</a>
        <a href="/serveurs/mysql.html" class="list-group-item list-group-item-action ">MySQL</a>
        <a href="/serveurs/neo4j.html" class="list-group-item list-group-item-action ">Neo4J</a>
        <a href="/serveurs/oracle.html" class="list-group-item list-group-item-action ">Oracle</a>
        <a href="/serveurs/teradata.html" class="list-group-item list-group-item-action ">TeraData</a>
    </div>


  </aside>
  <section class="page">

    <h1>Erreur de read-only status avec JDBC</h1>
    
    

    

<h2 id="symptômes">Symptômes</h2>

<p>J&rsquo;ai rencontré l&rsquo;erreur suivante :</p>

<pre><code>java.io.IOException: java.sql.SQLException: Could not retrieve transation read-only status server
Caused by: java.sql.SQLException: Could not retrieve transation read-only status server
Caused by: java.sql.SQLException: REPLACE INTO `db`.`test_table` (`timestamp`,`database`,`table`,`columns`,`lines`,`before`,`write`,`wait`) VALUES (?,?,?,?,?,?,?,?)
        ... 4 common frames omitted
Caused by: java.sql.SQLException: Could not retrieve transation read-only status server
        at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:1086) ~[mysql-connector-java-5.1.28.jar:na]
        at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:989) ~[mysql-connector-java-5.1.28.jar:na]
        at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:975) ~[mysql-connector-java-5.1.28.jar:na]
        at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:920) ~[mysql-connector-java-5.1.28.jar:na]
        at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:951) ~[mysql-connector-java-5.1.28.jar:na]
        at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:941) ~[mysql-connector-java-5.1.28.jar:na]
        at com.mysql.jdbc.ConnectionImpl.isReadOnly(ConnectionImpl.java:3955) ~[mysql-connector-java-5.1.28.jar:na]
        at com.mysql.jdbc.ConnectionImpl.isReadOnly(ConnectionImpl.java:3926) ~[mysql-connector-java-5.1.28.jar:na]
        at com.mysql.jdbc.PreparedStatement.executeBatch(PreparedStatement.java:1430) ~[mysql-connector-java-5.1.28.jar:na]
        at com.zaxxer.hikari.proxy.StatementProxy.executeBatch(StatementProxy.java:116) ~[HikariCP-java6-2.3.2.jar:na]
        at com.zaxxer.hikari.proxy.PreparedStatementJavassistProxy.executeBatch(PreparedStatementJavassistProxy.java) ~[HikariCP-java6-2.3.2.jar:na]
        ... 3 common frames omitted
Caused by: com.mysql.jdbc.exceptions.jdbc4.MySQLNonTransientConnectionException: Could not create connection to database server. Attempted reconnect 3 times. Giving up.
        at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method) ~[na:1.8.0_51]
        at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62) ~[na:1.8.0_51]
        at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45) ~[na:1.8.0_51]
        at java.lang.reflect.Constructor.newInstance(Constructor.java:422) ~[na:1.8.0_51]
        at com.mysql.jdbc.Util.handleNewInstance(Util.java:411) ~[mysql-connector-java-5.1.28.jar:na]
        at com.mysql.jdbc.Util.getInstance(Util.java:386) ~[mysql-connector-java-5.1.28.jar:na]
        at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:1015) ~[mysql-connector-java-5.1.28.jar:na]
        at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:989) ~[mysql-connector-java-5.1.28.jar:na]
        at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:975) ~[mysql-connector-java-5.1.28.jar:na]
        at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:920) ~[mysql-connector-java-5.1.28.jar:na]
        at com.mysql.jdbc.ConnectionImpl.connectWithRetries(ConnectionImpl.java:2395) ~[mysql-connector-java-5.1.28.jar:na]
        at com.mysql.jdbc.ConnectionImpl.createNewIO(ConnectionImpl.java:2316) ~[mysql-connector-java-5.1.28.jar:na]
        at com.mysql.jdbc.ConnectionImpl.execSQL(ConnectionImpl.java:2807) ~[mysql-connector-java-5.1.28.jar:na]
        at com.mysql.jdbc.ConnectionImpl.execSQL(ConnectionImpl.java:2768) ~[mysql-connector-java-5.1.28.jar:na]
        at com.mysql.jdbc.StatementImpl.executeQuery(StatementImpl.java:1651) ~[mysql-connector-java-5.1.28.jar:na]
        at com.mysql.jdbc.ConnectionImpl.isReadOnly(ConnectionImpl.java:3949) ~[mysql-connector-java-5.1.28.jar:na]
        ... 8 common frames omitted
Caused by: java.sql.SQLException: No database selected
        at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:1086) ~[mysql-connector-java-5.1.28.jar:na]
        at com.mysql.jdbc.MysqlIO.checkErrorPacket(MysqlIO.java:4237) ~[mysql-connector-java-5.1.28.jar:na]
        at com.mysql.jdbc.MysqlIO.checkErrorPacket(MysqlIO.java:4169) ~[mysql-connector-java-5.1.28.jar:na]
        at com.mysql.jdbc.MysqlIO.sendCommand(MysqlIO.java:2617) ~[mysql-connector-java-5.1.28.jar:na]
        at com.mysql.jdbc.MysqlIO.sqlQueryDirect(MysqlIO.java:2778) ~[mysql-connector-java-5.1.28.jar:na]
        at com.mysql.jdbc.ConnectionImpl.execSQL(ConnectionImpl.java:2819) ~[mysql-connector-java-5.1.28.jar:na]
        at com.mysql.jdbc.ConnectionImpl.setCatalog(ConnectionImpl.java:5443) ~[mysql-connector-java-5.1.28.jar:na]
        at com.mysql.jdbc.ConnectionImpl.connectWithRetries(ConnectionImpl.java:2368) ~[mysql-connector-java-5.1.28.jar:na]
        ... 13 common frames omitted
</code></pre>

<p>Au fil de la stacktrace on voit tout un tas de root cause la dernière étant <code>No database selected</code>. Mais toute ces
ne sont que la conséquence de quelque chose de plus grave. Il m&rsquo;est aussi arrivé d&rsquo;avoir :</p>

<pre><code>Caused by: java.sql.SQLException: Streaming result set com.mysql.jdbc.RowDataDynamic@62f3413a is still active.
            No statements may be issued when any streaming result sets are open and in use on a given connection.
            Ensure that you have called .close() on any active streaming result sets before attempting more queries.
</code></pre>

<p>Alors que toutes les connections sont systématiquement rendu au pool !</p>

<h2 id="solution">Solution</h2>

<p>Plusieurs solutions m&rsquo;ont été proposées mais seulement des solutions pour les problèmes visibles dans les stacktraces.
Le résultat c&rsquo;est qu&rsquo;il n&rsquo;y a plus d&rsquo;erreurs visible mais l&rsquo;exécution est bloqué en attente d&rsquo;on ne sait quoi.</p>

<p>La source réelle du problème est une option de performance dans le driver JDBC :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">config<span style="color:#f92672">.</span><span style="color:#a6e22e">addDataSourceProperty</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;cachePrepStmts&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">);</span>
config<span style="color:#f92672">.</span><span style="color:#a6e22e">addDataSourceProperty</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;prepStmtCacheSize&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;250&#34;</span><span style="color:#f92672">);</span>
config<span style="color:#f92672">.</span><span style="color:#a6e22e">addDataSourceProperty</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;prepStmtCacheSqlLimit&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;2048&#34;</span><span style="color:#f92672">);</span>
config<span style="color:#f92672">.</span><span style="color:#a6e22e">addDataSourceProperty</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;useServerPrepStmts&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">);</span></code></pre></div>
<p>J&rsquo;utilise HikariCP mais c&rsquo;est valable pour tout les gestionnaires de pool. L&rsquo;option <code>useServerPrepStmts</code> est sencé
améliorer les performance en cachant les PrepareStatement coté serveur. Mais MySQL 5.6 réagit mal a cette option . Les
statement se ferment mal. Du coup supprimer cette option résoud le problème.</p>



    
    
  </section>

  
      <aside class="toc">
        <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#symptômes">Symptômes</a></li>
<li><a href="#solution">Solution</a></li>
</ul></li>
</ul>
</nav>
      </aside>
  

</article>

<script src="/js/clipboard.min.js"></script>

<link href="/css/featherlight.min.css" rel="stylesheet">
<script src="/js/featherlight.min.js"></script>



<script src="/js/search.js"></script>


    
    

    
  </body>
</html>